#!/bin/bash

usage() {
    echo "Usage:"
    echo "  ./reduce_phoronix --sub_test <test_ran> --tmp_name <output_temp_file>"
    echo "Options:"
    echo "  -h          Show help"
    echo "  --sub_test  Specify the test data to reduce"
    echo "  --tmp_file  Specify output temp file"
    exit 1
}

# Initialize variables
test_ran="none"
tmp_file="none"

reduce_cockroach() {
    echo "Workload:Concurrency:Average:Deviation" > "$tmp_file"
    # Read and process the results file
    while IFS= read -r line; do
        # Check for lines containing workload and concurrency
        if [[ $line == *Workload* ]]; then
            # Extract Workload and Concurrency
            workload=$(echo "$line" | awk -F ': ' '{print $2}' | awk -F ' - ' '{print $1}')
            concurrency=$(echo "$line" | awk -F ': ' '{print $3}' | tr -d ':')
        fi
        if [[ $line == *Average* ]]; then
            # Extract Average
            average=$(echo "$line" | awk -F ': ' '{print $2}' | awk '{print $1}')
        fi
        if [[ $line == *Deviation* ]]; then
            # Extract Deviation
            deviation=$(echo "$line" | awk -F ': ' '{print $2}' | tr -d '%')
            # Append the extracted information to the output file
            echo "$workload:$concurrency:$average:$deviation" >> "$tmp_file"
        fi
        rm "$tmp_file"
    done < /tmp/results_phoronix_"$test_ran"_tuned_*.out
}

reduce_redis() {
    echo "Test:ParallelConnections:Average:Deviation" > "$tmp_file"
    # Read and process the results file
    while IFS= read -r line; do
        # Check for lines containing Test and Parallel Connections
        if [[ $line == *"Test:"* && $line == *"Parallel Connections:"* ]]; then
            # Extract Test and Parallel Connections
            test=$(echo "$line" | awk -F 'Test: ' '{print $2}' | awk -F ' - ' '{print $1}')
            parallel_connections=$(echo "$line" | awk -F ': ' '{print $3}' | tr -d ':')
        fi
        if [[ $line == *"Average:"* ]]; then
            # Extract Average
            average=$(echo "$line" | awk -F ': ' '{print $2}' | awk '{print $1}')
        fi
        if [[ $line == *"Deviation:"* ]]; then
            # Extract Deviation
            deviation=$(echo "$line" | awk -F ': ' '{print $2}' | tr -d '%')
            # Append the extracted information to the output file
            echo "$test:$parallel_connections:$average:$deviation" >> "$tmp_file"
        fi
        rm "$tmp_file"
    done < /tmp/results_phoronix_"$test_ran"_tuned_*.out
}

reduce_stress_ng() {
    egrep 'Test: |Average' results_phoronix_*.out | grep -v stress > tmpfile
    echo "Test:BOPs"
    toggle=0
    while IFS= read -r line
    do
      if [ $toggle -eq 0 ]; then
        out=`echo $line | cut -d':' -f2 | sed "s/^ //g" | sed "s/\[1\;34m//g"`
        printf "%s:" "$out"
        toggle=1
      else
        out=`echo $line | cut -d':' -f 2 | cut -d' ' -f 2 | sed "s/\[1\;34m//g"`
        printf "%s\n" $out
        toggle=0
      fi
    done < "tmpfile"
    rm tmpfile
}
# Check if an argument is passed
if [ $# -eq 0 ]; then
    usage
fi


# Process command line arguments
while [ $# -gt 0 ]; do
    case $1 in
        -h)
            usage
            ;;
        --sub_test)
            test_ran=$2
            shift 2
            ;;
        --tmp_file)
            tmp_file=$2
            shift 2
            ;;
        *)
            usage
            ;;
    esac
done

# Check if a test data to reduce is designated
if [ "$test_ran" == "none" ]; then
    echo "You need to designate a test to reduce."
    usage
fi
if [ "$tmp_file" == "none" ]; then
    echo "You need a file to output to"
    usage
fi

if [[ "$test_ran" == "cockroach" ]]; then
    reduce_cockroach
elif [[ "$test_ran" == "redis" ]]; then
    reduce_redis
elif [[ "$test_ran" == "stress-ng"]]; then
    reduce_stress_ng
else
    echo "Unsupported test: $test_ran"
    exit 1
fi